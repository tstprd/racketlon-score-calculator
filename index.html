<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <title>Racketlon Calc</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      padding: 16px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 20px; }
    header h1 { font-size: 1.5rem; margin-bottom: 4px; }
    header p { color: #888; font-size: 0.9rem; }
    .players-row { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    .player-input { flex: 1; }
    .player-input label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 4px; }
    .player-input input {
      width: 100%; padding: 10px; border: 2px solid #0f3460; border-radius: 8px;
      background: #16213e; color: #fff; font-size: 1rem; text-align: center;
    }
    .player-input input:focus { outline: none; border-color: #e94560; }
    .vs { color: #e94560; font-weight: bold; padding-top: 18px; }
    .scores-grid { background: #16213e; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .sport-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #0f3460; }
    .sport-row:last-child { border-bottom: none; }
    .sport-row.has-error .sport-name { color: #ff4757; }
    .sport-name { flex: 1; font-size: 0.95rem; }
    .score-group { display: flex; align-items: center; gap: 6px; }
    .score-input {
      width: 50px; padding: 8px 4px; border: 2px solid #0f3460; border-radius: 8px;
      background: #1a1a2e; color: #fff; font-size: 1.1rem; text-align: center;
      -moz-appearance: textfield;
    }
    .score-input::-webkit-outer-spin-button, .score-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .score-input:focus { outline: none; border-color: #e94560; }
    .score-input.error { border-color: #ff4757 !important; background: rgba(255,71,87,0.2); }
    .btn-21 {
      width: 36px; height: 36px; border: none; border-radius: 8px;
      background: #e94560; color: #fff; font-size: 0.85rem; font-weight: bold;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    .btn-21:active { transform: scale(0.95); background: #ff6b6b; }
    .score-sep { margin: 0 8px; color: #888; font-weight: bold; }
    .total-row { display: flex; align-items: center; padding: 16px 0 8px; border-top: 2px solid #e94560; margin-top: 8px; }
    .total-row .sport-name { font-weight: bold; }
    .total-score { font-size: 1.3rem; font-weight: bold; color: #ff6b6b; min-width: 50px; text-align: center; }
    .delta-display { background: #0f3460; border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 16px; }
    #deltaText { font-size: 1.1rem; font-weight: bold; }
    .delta-positive { color: #00d26a; }
    .delta-negative { color: #e94560; }
    .delta-zero { color: #ffc107; }
    .errors-box { background: rgba(255,71,87,0.15); border: 2px solid #ff4757; border-radius: 12px; padding: 12px; margin-bottom: 16px; }
    .errors-box h3 { color: #ff4757; font-size: 0.9rem; margin-bottom: 8px; }
    .errors-box ul { list-style: none; font-size: 0.85rem; color: #ff6b6b; }
    .errors-box li { padding: 4px 0; }
    .errors-box li::before { content: "âš ï¸ "; }
    .hidden { display: none !important; }
    .btn-clear { width: 100%; padding: 14px; border: 2px solid #888; border-radius: 12px; background: transparent; color: #888; font-size: 1rem; cursor: pointer; margin-bottom: 20px; }
    .btn-clear:active { border-color: #e94560; color: #e94560; }
    .analysis-section { background: #16213e; border-radius: 12px; padding: 16px; }
    .analysis-section h2 { font-size: 1rem; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #0f3460; }
    .analysis-item { padding: 10px 12px; margin-bottom: 8px; background: #0f3460; border-radius: 8px; border-left: 4px solid #e94560; font-size: 0.95rem; }
    .analysis-item.winner { border-left-color: #00d26a; background: rgba(0,210,106,0.1); }
    .analysis-item.gummiarm_scenario { border-left-color: #ffc107; background: rgba(255,193,7,0.1); }
    .analysis-item.scenario { border-left-color: #00bcd4; }
    .placeholder { color: #888; text-align: center; font-style: italic; }
    footer { text-align: center; padding: 20px 0; color: #888; font-size: 0.8rem; }
    footer a { color: #ff6b6b; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“ğŸ¸ğŸ¾ Racketlon Calc</h1>
      <p>Calculateur de scores</p>
    </header>
    <main>
      <div class="players-row">
        <div class="player-input">
          <label>Joueur A</label>
          <input type="text" id="playerA" placeholder="Nom">
        </div>
        <div class="vs">VS</div>
        <div class="player-input">
          <label>Joueur B</label>
          <input type="text" id="playerB" placeholder="Nom">
        </div>
      </div>
      <div class="scores-grid">
        <div class="sport-row" id="row-tt">
          <span class="sport-name">ğŸ“ Ping-pong</span>
          <div class="score-group">
            <input type="number" class="score-input" id="tt-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('tt-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="tt-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('tt-b')">21</button>
          </div>
        </div>
        <div class="sport-row" id="row-bad">
          <span class="sport-name">ğŸ¸ Badminton</span>
          <div class="score-group">
            <input type="number" class="score-input" id="bad-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('bad-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="bad-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('bad-b')">21</button>
          </div>
        </div>
        <div class="sport-row" id="row-sq">
          <span class="sport-name">ğŸ¯ Squash</span>
          <div class="score-group">
            <input type="number" class="score-input" id="sq-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('sq-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="sq-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('sq-b')">21</button>
          </div>
        </div>
        <div class="sport-row" id="row-ten">
          <span class="sport-name">ğŸ¾ Tennis</span>
          <div class="score-group">
            <input type="number" class="score-input" id="ten-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('ten-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="ten-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('ten-b')">21</button>
          </div>
        </div>
        <div class="total-row">
          <span class="sport-name">ğŸ“Š TOTAL</span>
          <span class="total-score" id="totalA">0</span>
          <span class="score-sep">-</span>
          <span class="total-score" id="totalB">0</span>
        </div>
      </div>
      <div id="errorsBox" class="errors-box hidden">
        <h3>âš ï¸ Scores invalides</h3>
        <ul id="errorsList"></ul>
      </div>
      <div class="delta-display">
        <span id="deltaText">Entrez les scores</span>
      </div>
      <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ Effacer tout</button>
      <section class="analysis-section">
        <h2>ğŸ“ˆ Analyse</h2>
        <div id="analysisContent">
          <p class="placeholder">Entrez les scores pour voir l'analyse</p>
        </div>
      </section>
    </main>
    <footer>
      <p>Racketlon Calc â€¢ <a href="https://www.racketlon.net" target="_blank">RÃ¨gles FIR</a></p>
    </footer>
  </div>
  <script>
    const SPORTS_CONFIG = [
      { id: 'tt', name: 'Ping-pong', row: 'row-tt', key: 'tabletennis' },
      { id: 'bad', name: 'Badminton', row: 'row-bad', key: 'badminton' },
      { id: 'sq', name: 'Squash', row: 'row-sq', key: 'squash' },
      { id: 'ten', name: 'Tennis', row: 'row-ten', key: 'tennis' }
    ];

    function set21(id) {
      document.getElementById(id).value = 21;
      update();
    }

    function clearAll() {
      document.getElementById('playerA').value = '';
      document.getElementById('playerB').value = '';
      document.querySelectorAll('.score-input').forEach(i => i.value = '');
      update();
    }

    function getScoreRaw(prefix) {
      const aEl = document.getElementById(prefix + '-a');
      const bEl = document.getElementById(prefix + '-b');
      return { a: aEl.value, b: bEl.value, aEl, bEl };
    }

    function validateScores() {
      const errors = [];
      let lastFilledIndex = -1;
      document.querySelectorAll('.score-input').forEach(el => el.classList.remove('error'));
      document.querySelectorAll('.sport-row').forEach(el => el.classList.remove('has-error'));

      SPORTS_CONFIG.forEach((sport, index) => {
        const { a, b, aEl, bEl } = getScoreRaw(sport.id);
        const aNum = parseInt(a), bNum = parseInt(b);
        const hasA = a !== '', hasB = b !== '';
        const hasBoth = hasA && hasB;

        if (hasBoth) {
          lastFilledIndex = index;
          if (aNum === 21 && bNum === 21) {
            errors.push({ sport: sport.name, msg: 'Les deux ne peuvent pas avoir 21' });
            aEl.classList.add('error'); bEl.classList.add('error');
            document.getElementById(sport.row).classList.add('has-error');
          } else if (aNum !== 21 && bNum !== 21) {
            errors.push({ sport: sport.name, msg: 'Un joueur doit avoir 21' });
            aEl.classList.add('error'); bEl.classList.add('error');
            document.getElementById(sport.row).classList.add('has-error');
          }
        } else if (hasA || hasB) {
          errors.push({ sport: sport.name, msg: 'Score incomplet' });
          if (hasA) aEl.classList.add('error');
          if (hasB) bEl.classList.add('error');
          document.getElementById(sport.row).classList.add('has-error');
        }
      });

      let foundGap = false;
      SPORTS_CONFIG.forEach((sport, index) => {
        const { a, b } = getScoreRaw(sport.id);
        const hasBoth = a !== '' && b !== '';
        if (hasBoth && foundGap) {
          errors.push({ sport: sport.name, msg: 'Remplir dans l\'ordre' });
          document.getElementById(sport.row).classList.add('has-error');
        }
        if (!hasBoth && index < lastFilledIndex) foundGap = true;
      });

      return errors;
    }

    function update() {
      const errors = validateScores();
      const errorsBox = document.getElementById('errorsBox');
      const errorsList = document.getElementById('errorsList');

      if (errors.length > 0) {
        errorsList.innerHTML = errors.map(e => `<li><strong>${e.sport}</strong>: ${e.msg}</li>`).join('');
        errorsBox.classList.remove('hidden');
      } else {
        errorsBox.classList.add('hidden');
      }

      const scores = {};
      let totalA = 0, totalB = 0;

      SPORTS_CONFIG.forEach(sport => {
        const { a, b } = getScoreRaw(sport.id);
        const aNum = parseInt(a), bNum = parseInt(b);
        if (a !== '' && b !== '' && (aNum === 21 || bNum === 21) && !(aNum === 21 && bNum === 21)) {
          scores[sport.key] = `${a}-${b}`;
          totalA += aNum;
          totalB += bNum;
        }
      });

      document.getElementById('totalA').textContent = totalA;
      document.getElementById('totalB').textContent = totalB;

      const playerA = document.getElementById('playerA').value || 'Joueur A';
      const playerB = document.getElementById('playerB').value || 'Joueur B';
      const delta = totalA - totalB;
      const deltaEl = document.getElementById('deltaText');

      if (totalA === 0 && totalB === 0) {
        deltaEl.textContent = 'Entrez les scores';
        deltaEl.className = '';
      } else if (delta > 0) {
        deltaEl.textContent = `${playerA} mÃ¨ne de ${delta} pts`;
        deltaEl.className = 'delta-positive';
      } else if (delta < 0) {
        deltaEl.textContent = `${playerB} mÃ¨ne de ${Math.abs(delta)} pts`;
        deltaEl.className = 'delta-negative';
      } else {
        deltaEl.textContent = 'Ã‰galitÃ© parfaite';
        deltaEl.className = 'delta-zero';
      }

      updateAnalysis(errors.length === 0 ? scores : {}, playerA, playerB, totalA, totalB);
    }

    function updateAnalysis(scores, playerA, playerB, totalA, totalB) {
      const container = document.getElementById('analysisContent');
      const sportsPlayed = Object.keys(scores).length;
      const sportsRemaining = 4 - sportsPlayed;
      const maxRemaining = sportsRemaining * 21;
      const delta = totalA - totalB;

      if (sportsPlayed === 0) {
        container.innerHTML = '<p class="placeholder">Entrez des scores valides</p>';
        return;
      }

      let html = `<div class="analysis-item">ğŸ“Š Score: <strong>${totalA}</strong> - <strong>${totalB}</strong> (${sportsPlayed}/4 sports)</div>`;

      if (sportsPlayed === 4) {
        if (delta === 0) {
          html += `<div class="analysis-item gummiarm_scenario">âš¡ GUMMIARM ! Un point dÃ©cisif au tennis</div>`;
        } else {
          const winner = delta > 0 ? playerA : playerB;
          html += `<div class="analysis-item winner">ğŸ† ${winner} remporte le match !</div>`;
        }
      } else if (Math.abs(delta) > maxRemaining) {
        const winner = delta > 0 ? playerA : playerB;
        html += `<div class="analysis-item winner">ğŸ† ${winner} a dÃ©jÃ  gagnÃ© ! Avance insurmontable.</div>`;
      } else {
        if (delta > 0) {
          html += `<div class="analysis-item">${playerA} mÃ¨ne de ${delta} points</div>`;
        } else if (delta < 0) {
          html += `<div class="analysis-item">${playerB} mÃ¨ne de ${Math.abs(delta)} points</div>`;
        } else {
          html += `<div class="analysis-item">Ã‰galitÃ© parfaite</div>`;
        }

        const nextSport = ['tabletennis', 'badminton', 'squash', 'tennis'].find(s => !scores[s]);
        const nextLabel = {tabletennis: 'Ping-pong', badminton: 'Badminton', squash: 'Squash', tennis: 'Tennis'}[nextSport];

        if (sportsRemaining === 1) {
          // Tennis reste - affichage en points Ã  marquer
          const absDelta = Math.abs(delta);
          const leader = delta > 0 ? playerA : playerB;
          const trailer = delta > 0 ? playerB : playerA;
          
          // Calcul: pour que trailer gagne, il doit rattraper l'Ã©cart + 1 pt
          // Si trailer fait 21, leader doit faire max (21 - (absDelta + 1)) = (20 - absDelta)
          const leaderMaxForTrailerWin = 20 - absDelta;
          const gummiarmLeaderScore = 21 - absDelta;
          
          if (absDelta > 21) {
            // Ã‰cart insurmontable mÃªme avec 21-0
            html += `<div class="analysis-item winner">ğŸ† ${leader} a dÃ©jÃ  gagnÃ© ! MÃªme 21-0 ne suffit pas.</div>`;
          } else if (absDelta >= 21 || leaderMaxForTrailerWin < 0) {
            // Ã‰cart de 21+ : seul gummiarm possible via 21-0
            html += `<div class="analysis-item scenario">ğŸ† ${trailer} ne peut plus gagner au tennis</div>`;
            html += `<div class="analysis-item gummiarm_scenario">âš¡ Gummiarm si ${trailer} fait 21-0</div>`;
            html += `<div class="analysis-item scenario">ğŸ† ${leader} gagne sinon</div>`;
          } else if (delta !== 0) {
            // Cas normal: trailer peut encore gagner
            html += `<div class="analysis-item scenario">ğŸ† ${trailer} doit marquer 21 pts et ${leader} max ${leaderMaxForTrailerWin} pts</div>`;
            html += `<div class="analysis-item scenario">ğŸ† ${leader} gagne si marque ${leaderMaxForTrailerWin + 2}+ pts, ou gagne le set</div>`;
            html += `<div class="analysis-item gummiarm_scenario">âš¡ Gummiarm si ${trailer} fait 21 et ${leader} fait ${gummiarmLeaderScore}</div>`;
          } else {
            // Ã‰galitÃ©
            html += `<div class="analysis-item scenario">ğŸ† Le gagnant du ${nextLabel} remporte le match !</div>`;
            html += `<div class="analysis-item gummiarm_scenario">âš¡ Gummiarm si Ã©galitÃ© au ${nextLabel}</div>`;
          }
        } else if (sportsRemaining === 2) {
          // Squash + Tennis restent
          html += `<div class="analysis-item">ğŸ¯ Prochain : ${nextLabel}</div>`;
          const skipThreshold = 22 - Math.abs(delta);
          if (delta > 0 && skipThreshold <= 21) {
            html += `<div class="analysis-item scenario">ğŸ† ${playerA} gagne SANS tennis si ${nextLabel} â‰¥ 21-${21 - skipThreshold}</div>`;
          } else if (delta < 0 && skipThreshold <= 21) {
            html += `<div class="analysis-item scenario">ğŸ† ${playerB} gagne SANS tennis si ${nextLabel} â‰¥ 21-${21 - skipThreshold}</div>`;
          }
        }
      }

      container.innerHTML = html;
    }

    document.querySelectorAll('.score-input').forEach(input => {
      input.addEventListener('input', () => {
        if (input.value > 21) input.value = 21;
        if (input.value < 0) input.value = 0;
        update();
      });
      input.addEventListener('focus', () => input.select());
    });

    document.getElementById('playerA').addEventListener('input', update);
    document.getElementById('playerB').addEventListener('input', update);

    update();
  </script>
</body>
</html>
