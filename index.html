<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Calculateur de scores Racketlon">
  <title>Racketlon Calc</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèì</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      padding: 16px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 20px; }
    header h1 { font-size: 1.5rem; margin-bottom: 4px; }
    header p { color: #888; font-size: 0.9rem; }
    
    .players-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .player-input { flex: 1; }
    .player-input label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 4px; }
    .player-input input {
      width: 100%;
      padding: 10px;
      border: 2px solid #0f3460;
      border-radius: 8px;
      background: #16213e;
      color: #fff;
      font-size: 1rem;
      text-align: center;
    }
    .player-input input:focus { outline: none; border-color: #e94560; }
    
    .vs { color: #e94560; font-weight: bold; padding-top: 18px; }
    
    .scores-grid {
      background: #16213e;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .sport-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #0f3460;
    }
    .sport-row:last-child { border-bottom: none; }
    .sport-row.has-error .sport-name { color: #ff4757; }
    
    .sport-name { flex: 1; font-size: 0.95rem; }
    
    .score-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .score-input {
      width: 50px;
      padding: 8px 4px;
      border: 2px solid #0f3460;
      border-radius: 8px;
      background: #1a1a2e;
      color: #fff;
      font-size: 1.1rem;
      text-align: center;
      -moz-appearance: textfield;
    }
    .score-input::-webkit-outer-spin-button,
    .score-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .score-input:focus { outline: none; border-color: #e94560; }
    .score-input.error { 
      border-color: #ff4757 !important; 
      background: rgba(255, 71, 87, 0.2);
    }
    
    .btn-21 {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: #e94560;
      color: #fff;
      font-size: 0.85rem;
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-21:active { transform: scale(0.95); background: #ff6b6b; }
    
    .score-sep {
      margin: 0 8px;
      color: #888;
      font-weight: bold;
    }
    
    .total-row {
      display: flex;
      align-items: center;
      padding: 16px 0 8px;
      border-top: 2px solid #e94560;
      margin-top: 8px;
    }
    .total-row .sport-name { font-weight: bold; }
    .total-score {
      font-size: 1.3rem;
      font-weight: bold;
      color: #ff6b6b;
      min-width: 50px;
      text-align: center;
    }
    
    .delta-display {
      background: #0f3460;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    #deltaText { font-size: 1.1rem; font-weight: bold; }
    .delta-positive { color: #00d26a; }
    .delta-negative { color: #e94560; }
    .delta-zero { color: #ffc107; }
    
    .errors-box {
      background: rgba(255, 71, 87, 0.15);
      border: 2px solid #ff4757;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .errors-box h3 {
      color: #ff4757;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .errors-box ul {
      list-style: none;
      font-size: 0.85rem;
      color: #ff6b6b;
    }
    .errors-box li { padding: 4px 0; }
    .errors-box li::before { content: "‚ö†Ô∏è "; }
    .hidden { display: none; }
    
    .btn-clear {
      width: 100%;
      padding: 14px;
      border: 2px solid #888;
      border-radius: 12px;
      background: transparent;
      color: #888;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .btn-clear:active { border-color: #e94560; color: #e94560; }
    
    .analysis-section {
      background: #16213e;
      border-radius: 12px;
      padding: 16px;
    }
    .analysis-section h2 {
      font-size: 1rem;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #0f3460;
    }
    
    .analysis-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: #0f3460;
      border-radius: 8px;
      border-left: 4px solid #e94560;
      font-size: 0.95rem;
    }
    .analysis-item.winner { border-left-color: #00d26a; background: rgba(0,210,106,0.1); }
    .analysis-item.gummiarm_scenario { border-left-color: #ffc107; background: rgba(255,193,7,0.1); }
    .analysis-item.scenario { border-left-color: #00bcd4; }
    
    .placeholder { color: #888; text-align: center; font-style: italic; }
    
    footer { text-align: center; padding: 20px 0; color: #888; font-size: 0.8rem; }
    footer a { color: #ff6b6b; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèìüè∏üéæ Racketlon Calc</h1>
      <p>Calculateur de scores</p>
    </header>

    <main>
      <div class="players-row">
        <div class="player-input">
          <label>Joueur A</label>
          <input type="text" id="playerA" placeholder="Nom">
        </div>
        <div class="vs">VS</div>
        <div class="player-input">
          <label>Joueur B</label>
          <input type="text" id="playerB" placeholder="Nom">
        </div>
      </div>

      <div class="scores-grid">
        <div class="sport-row" data-sport="tabletennis" id="row-tt">
          <span class="sport-name">üèì Ping-pong</span>
          <div class="score-group">
            <input type="number" class="score-input" id="tt-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('tt-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="tt-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('tt-b')">21</button>
          </div>
        </div>
        
        <div class="sport-row" data-sport="badminton" id="row-bad">
          <span class="sport-name">üè∏ Badminton</span>
          <div class="score-group">
            <input type="number" class="score-input" id="bad-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('bad-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="bad-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('bad-b')">21</button>
          </div>
        </div>
        
        <div class="sport-row" data-sport="squash" id="row-sq">
          <span class="sport-name">üéØ Squash</span>
          <div class="score-group">
            <input type="number" class="score-input" id="sq-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('sq-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="sq-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('sq-b')">21</button>
          </div>
        </div>
        
        <div class="sport-row" data-sport="tennis" id="row-ten">
          <span class="sport-name">üéæ Tennis</span>
          <div class="score-group">
            <input type="number" class="score-input" id="ten-a" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('ten-a')">21</button>
          </div>
          <span class="score-sep">-</span>
          <div class="score-group">
            <input type="number" class="score-input" id="ten-b" min="0" max="21" inputmode="numeric">
            <button class="btn-21" onclick="set21('ten-b')">21</button>
          </div>
        </div>
        
        <div class="total-row">
          <span class="sport-name">üìä TOTAL</span>
          <span class="total-score" id="totalA">0</span>
          <span class="score-sep">-</span>
          <span class="total-score" id="totalB">0</span>
        </div>
      </div>

      <div id="errorsBox" class="errors-box hidden">
        <h3>‚ö†Ô∏è Scores invalides</h3>
        <ul id="errorsList"></ul>
      </div>

      <div class="delta-display">
        <span id="deltaText">Entrez les scores</span>
      </div>
      
      <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Effacer tout</button>

      <section class="analysis-section">
        <h2>üìà Analyse</h2>
        <div id="analysisContent">
          <p class="placeholder">Entrez les scores pour voir l'analyse</p>
        </div>
      </section>
    </main>

    <footer>
      <p>Racketlon Calc ‚Ä¢ <a href="https://www.racketlon.net" target="_blank">R√®gles FIR</a></p>
    </footer>
  </div>

  <script src="scoring.js"></script>
  <script>
    const SPORTS = [
      { id: 'tt', name: 'Ping-pong', row: 'row-tt' },
      { id: 'bad', name: 'Badminton', row: 'row-bad' },
      { id: 'sq', name: 'Squash', row: 'row-sq' },
      { id: 'ten', name: 'Tennis', row: 'row-ten' }
    ];
    
    function set21(id) {
      document.getElementById(id).value = 21;
      update();
    }
    
    function clearAll() {
      document.getElementById('playerA').value = '';
      document.getElementById('playerB').value = '';
      document.querySelectorAll('.score-input').forEach(i => i.value = '');
      update();
    }
    
    function getScoreRaw(prefix) {
      const aEl = document.getElementById(prefix + '-a');
      const bEl = document.getElementById(prefix + '-b');
      const a = aEl.value;
      const b = bEl.value;
      return { a, b, aEl, bEl };
    }
    
    function validateScores() {
      const errors = [];
      let lastFilledIndex = -1;
      
      // Clear all error states
      document.querySelectorAll('.score-input').forEach(el => el.classList.remove('error'));
      document.querySelectorAll('.sport-row').forEach(el => el.classList.remove('has-error'));
      
      SPORTS.forEach((sport, index) => {
        const { a, b, aEl, bEl } = getScoreRaw(sport.id);
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        const hasA = a !== '';
        const hasB = b !== '';
        const hasBoth = hasA && hasB;
        const hasAny = hasA || hasB;
        
        // Check if this sport is filled
        if (hasBoth) {
          lastFilledIndex = index;
          
          // Rule 1: Both can't be 21
          if (aNum === 21 && bNum === 21) {
            errors.push({ sport: sport.name, msg: 'Les deux joueurs ne peuvent pas avoir 21' });
            aEl.classList.add('error');
            bEl.classList.add('error');
            document.getElementById(sport.row).classList.add('has-error');
          }
          // Rule 2: At least one must be 21 (set is finished)
          else if (aNum !== 21 && bNum !== 21) {
            errors.push({ sport: sport.name, msg: 'Un joueur doit avoir 21 pour finir le set' });
            aEl.classList.add('error');
            bEl.classList.add('error');
            document.getElementById(sport.row).classList.add('has-error');
          }
        }
        // Only one score entered
        else if (hasAny) {
          errors.push({ sport: sport.name, msg: 'Score incomplet' });
          if (hasA) aEl.classList.add('error');
          if (hasB) bEl.classList.add('error');
          document.getElementById(sport.row).classList.add('has-error');
        }
      });
      
      // Rule 3: Check for gaps (e.g., ping-pong empty but squash filled)
      let foundGap = false;
      SPORTS.forEach((sport, index) => {
        const { a, b } = getScoreRaw(sport.id);
        const hasBoth = a !== '' && b !== '';
        
        if (hasBoth && foundGap) {
          errors.push({ sport: sport.name, msg: 'Remplir les sports dans l\'ordre' });
          document.getElementById(sport.row).classList.add('has-error');
          document.getElementById(sport.id + '-a').classList.add('error');
          document.getElementById(sport.id + '-b').classList.add('error');
        }
        
        if (!hasBoth && index < lastFilledIndex) {
          foundGap = true;
        }
      });
      
      return errors;
    }
    
    function update() {
      // Validate
      const errors = validateScores();
      const errorsBox = document.getElementById('errorsBox');
      const errorsList = document.getElementById('errorsList');
      
      if (errors.length > 0) {
        errorsList.innerHTML = errors.map(e => `<li><strong>${e.sport}</strong>: ${e.msg}</li>`).join('');
        errorsBox.classList.remove('hidden');
      } else {
        errorsBox.classList.add('hidden');
      }
      
      // Get valid scores only
      const scores = {};
      let totalA = 0, totalB = 0;
      
      SPORTS.forEach(sport => {
        const { a, b } = getScoreRaw(sport.id);
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        
        if (a !== '' && b !== '' && (aNum === 21 || bNum === 21) && !(aNum === 21 && bNum === 21)) {
          scores[sport.id === 'tt' ? 'tabletennis' : sport.id === 'bad' ? 'badminton' : sport.id === 'sq' ? 'squash' : 'tennis'] = `${a}-${b}`;
          totalA += aNum;
          totalB += bNum;
        }
      });
      
      document.getElementById('totalA').textContent = totalA;
      document.getElementById('totalB').textContent = totalB;
      
      // Delta
      const playerA = document.getElementById('playerA').value || 'Joueur A';
      const playerB = document.getElementById('playerB').value || 'Joueur B';
      const delta = totalA - totalB;
      const deltaEl = document.getElementById('deltaText');
      
      if (totalA === 0 && totalB === 0) {
        deltaEl.textContent = 'Entrez les scores';
        deltaEl.className = '';
      } else if (delta > 0) {
        deltaEl.textContent = `${playerA} m√®ne de ${delta} pts`;
        deltaEl.className = 'delta-positive';
      } else if (delta < 0) {
        deltaEl.textContent = `${playerB} m√®ne de ${Math.abs(delta)} pts`;
        deltaEl.className = 'delta-negative';
      } else {
        deltaEl.textContent = '√âgalit√© parfaite';
        deltaEl.className = 'delta-zero';
      }
      
      // Analysis (only if no errors)
      updateAnalysis(errors.length === 0 ? scores : {}, playerA, playerB);
    }
    
    function updateAnalysis(scores, playerA, playerB) {
      const container = document.getElementById('analysisContent');
      
      if (!Object.values(scores).some(s => s)) {
        container.innerHTML = '<p class="placeholder">Entrez des scores valides pour voir l\'analyse</p>';
        return;
      }
      
      const result = analyzeMatch(scores, playerA, playerB);
      let html = '';
      
      if (result.status === 'finished' && result.winner) {
        html += `<div class="analysis-item winner">üèÜ ${result.winner} remporte le match !</div>`;
      } else if (result.status === 'gummiarm') {
        html += `<div class="analysis-item gummiarm_scenario">‚ö° GUMMIARM ! Un point d√©cisif au tennis</div>`;
      }
      
      html += `<div class="analysis-item">üìä Score: <strong>${result.totalA}</strong> - <strong>${result.totalB}</strong> (${result.sportsPlayed}/4 sports)</div>`;
      
      for (const item of result.analysis) {
        html += `<div class="analysis-item ${item.type || ''}">${item.message}</div>`;
      }
      
      container.innerHTML = html;
    }
    
    // Event listeners
    document.querySelectorAll('.score-input').forEach(input => {
      input.addEventListener('input', () => {
        if (input.value > 21) input.value = 21;
        if (input.value < 0) input.value = 0;
        update();
      });
      input.addEventListener('focus', () => input.select());
    });
    
    document.getElementById('playerA').addEventListener('input', update);
    document.getElementById('playerB').addEventListener('input', update);
    
    // Init
    update();
  </script>
</body>
</html>
